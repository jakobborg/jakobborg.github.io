<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>jkbb</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:ital,wght@1,100&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        color-scheme: dark;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        width: 100%;
        height: 100%;
        margin: 0;
      }

      body {
        position: relative;
        display: flex;
        align-items: flex-end;
        justify-content: flex-start;
        padding: clamp(1.25rem, 3vw, 3rem);
        background-image: url("https://chatgpt.com/backend-api/estuary/public_content/enc/eyJpZCI6Im1fNjk5NzA1MDdiMjIwODE5MWFiODIyOWVkYWY1ODY0NGY6ZmlsZV8wMDAwMDAwMGY5OTg3MjBhOWNmODE5ZWI1ZjljYTljOSIsInRzIjoiMjA1MDMiLCJwIjoicHlpIiwiY2lkIjoiMSIsInNpZyI6ImVjODVjNzhlZWNkNjk0Mzc2OGIyMmRhOGE2OGU5MDcyNWY4Mjc1ZmYyZjVmYTRiNTQ5NjM2ZDFmM2QyY2QxMDMiLCJ2IjoiMCIsImdpem1vX2lkIjpudWxsLCJjcyI6bnVsbCwiY2RuIjpudWxsLCJjcCI6bnVsbCwibWEiOm51bGx9");
        background-size: cover;
        background-position: center 60%;
        background-repeat: no-repeat;
      }

      .content {
        color: #fff;
        font-family: "Inter", sans-serif;
        font-style: italic;
        font-weight: 200;
        letter-spacing: 0.18em;
        text-transform: lowercase;
        text-align: left;
        line-height: 1.1;
      }

      .brand-link {
        color: inherit;
        text-decoration: none;
        font-size: clamp(1.4rem, 3.6vw, 2.8rem);
        display: inline-block;
      }

      .subtitle {
        margin-top: 0.2rem;
        font-size: clamp(1rem, 2.4vw, 1.8rem);
        white-space: pre-line;
      }

      .subtitle-link {
        color: inherit;
        text-decoration: underline;
        text-underline-offset: 0.16em;
      }

      .overlay {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(6, 10, 18, 0.46);
        z-index: 20;
      }

      .overlay.is-open {
        display: flex;
      }

      .overlay-inner {
        position: relative;
        width: min(420px, 88vw);
      }

      .overlay-player {
        display: block;
        width: min(360px, 100%);
        height: auto;
        aspect-ratio: 1 / 1;
        margin: 0 auto;
        border: 0;
        border-radius: 10px;
        background: rgba(28, 42, 58, 0.9);
        box-shadow: 0 16px 30px rgba(8, 14, 24, 0.45);
      }

      .overlay-fallback {
        margin: 0;
        padding: 1rem 1.25rem;
        border-radius: 10px;
        background: rgba(28, 42, 58, 0.9);
        color: #fff;
        font-family: "Inter", sans-serif;
        letter-spacing: 0.04em;
      }

      .overlay-fallback a {
        color: #a9ccf0;
      }

      .overlay-close {
        position: absolute;
        top: -0.8rem;
        right: -0.8rem;
        width: 2rem;
        height: 2rem;
        border: 0;
        border-radius: 999px;
        background: rgba(28, 42, 58, 0.95);
        color: #fff;
        cursor: pointer;
        font-size: 1.15rem;
        line-height: 1;
      }

      .archive-link {
        position: absolute;
        right: clamp(1.25rem, 3vw, 3rem);
        bottom: clamp(1.25rem, 3vw, 3rem);
        color: #fff;
        font-family: "Inter", sans-serif;
        font-style: italic;
        font-weight: 200;
        font-size: clamp(0.8rem, 1.5vw, 1.2rem);
        letter-spacing: 0.14em;
        text-transform: lowercase;
        text-decoration: none;
      }
    </style>
  </head>
  <body>
    <main class="content">
      <a class="brand-link" href="/">jkbb</a>
      <div class="subtitle"><a id="subtitle-link" class="subtitle-link" href="#"></a></div>
    </main>

    <a class="archive-link" href="#">archive</a>

    <div id="overlay" class="overlay" aria-hidden="true">
      <div class="overlay-inner">
        <button id="overlay-close" class="overlay-close" aria-label="Close player">Ã—</button>
        <div id="media" aria-live="polite"></div>
      </div>
    </div>

    <script>
      const subtitleLinkNode = document.getElementById("subtitle-link");
      const mediaNode = document.getElementById("media");
      const overlayNode = document.getElementById("overlay");
      const overlayCloseNode = document.getElementById("overlay-close");

      const getSoundCloudEmbedUrl = (url, autoPlay = false) => {
        try {
          const parsed = new URL(url);
          const hostname = parsed.hostname.toLowerCase();
          const isSoundCloudLink =
            hostname.includes("soundcloud.com") || hostname === "snd.sc" || hostname.endsWith(".snd.sc");

          if (!isSoundCloudLink) return null;

          const shareUrl = parsed.href;

          if (hostname === "w.soundcloud.com") {
            const existingUrl = parsed.searchParams.get("url");
            if (!existingUrl) return shareUrl;

            const widgetParams = new URLSearchParams(parsed.search);
            widgetParams.set("url", existingUrl);
            widgetParams.set("color", "#7a9ab8");
            widgetParams.set("auto_play", autoPlay ? "true" : "false");
            widgetParams.set("hide_related", "true");
            widgetParams.set("show_comments", "false");
            widgetParams.set("show_user", "true");
            widgetParams.set("show_reposts", "false");
            widgetParams.set("show_teaser", "false");
            widgetParams.set("visual", "true");
            return `https://w.soundcloud.com/player/?${widgetParams.toString()}`;
          }

          const params = new URLSearchParams({
            url: shareUrl,
            color: "#7a9ab8",
            auto_play: autoPlay ? "true" : "false",
            hide_related: "true",
            show_comments: "false",
            show_user: "true",
            show_reposts: "false",
            show_teaser: "false",
            visual: "true"
          });
          return `https://w.soundcloud.com/player/?${params.toString()}`;
        } catch {
          return null;
        }
      };

      const resolveEmbedFromUrl = (url, autoPlay = false) => {
        const soundcloud = getSoundCloudEmbedUrl(url, autoPlay);
        if (soundcloud) {
          return { embedUrl: soundcloud, height: "360", allowFullscreen: false };
        }

        return null;
      };

      const renderMedia = (content, autoPlay = false) => {
        mediaNode.innerHTML = "";

        const mediaUrl =
          content.mediaUrl ||
          content.media_link ||
          (content.media && content.media.url) ||
          "";

        if (!mediaUrl) return;

        const media = resolveEmbedFromUrl(mediaUrl, autoPlay);
        if (!media) {
          mediaNode.innerHTML = `<p class="overlay-fallback">Could not load embedded player. <a href="${mediaUrl}" target="_blank" rel="noopener noreferrer">Open track in a new tab</a>.</p>`;
          return;
        }

        const iframe = document.createElement("iframe");
        iframe.src = media.embedUrl;
        iframe.height = media.height;
        iframe.className = "overlay-player";
        iframe.loading = "lazy";
        iframe.referrerPolicy = "strict-origin-when-cross-origin";
        iframe.allow =
          "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";

        if (media.allowFullscreen) {
          iframe.allowFullscreen = true;
        }

        mediaNode.appendChild(iframe);
      };

      const openOverlay = (content) => {
        overlayNode.classList.add("is-open");
        overlayNode.setAttribute("aria-hidden", "false");
        renderMedia(content, true);
      };

      const closeOverlay = () => {
        overlayNode.classList.remove("is-open");
        overlayNode.setAttribute("aria-hidden", "true");
        mediaNode.innerHTML = "";
      };

      overlayCloseNode.addEventListener("click", closeOverlay);
      overlayNode.addEventListener("click", (event) => {
        if (event.target === overlayNode) {
          closeOverlay();
        }
      });

      fetch("./front-page.json")
        .then((response) => {
          if (!response.ok) {
            throw new Error("Could not load front-page.json");
          }
          return response.json();
        })
        .then((content) => {
          subtitleLinkNode.textContent = content.subtitle || "";
          subtitleLinkNode.addEventListener("click", (event) => {
            event.preventDefault();
            openOverlay(content);
          });
        })
        .catch(() => {
          subtitleLinkNode.textContent = "";
          mediaNode.innerHTML = "";
        });
    </script>
  </body>
</html>
